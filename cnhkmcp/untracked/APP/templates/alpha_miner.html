<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha Miner - AIæŒ–çŸ¿å·¥åŠ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .miner-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .miner-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .miner-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-info {
            position: absolute;
            right: 0;
            top: 0;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.85em;
            color: #555;
        }

        .workflow-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
            border-left: 4px solid #667eea;
            padding-left: 10px;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .resource-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e9ecef;
        }

        .resource-card h3 {
            margin-top: 0;
            color: #667eea;
            font-size: 1.2em;
        }

        .resource-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .resource-item {
            padding: 5px;
            margin: 3px 0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .resource-item:hover {
            background: #667eea;
            color: white;
        }

        .generation-panel {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .param-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .param-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .param-item select,
        .param-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: transform 0.2s;
        }

        .btn-generate:hover {
            transform: scale(1.05);
        }

        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-display {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .expression-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            margin: 10px 0;
            word-break: break-all;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-running {
            background: #ffc107;
            color: #000;
        }

        .status-complete {
            background: #28a745;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .llm-config {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="miner-container">
        <a href="/" class="back-button">â† è¿”å›é¦–é¡µ</a>
        
        <div class="miner-header">
            <h1>â›ï¸ Alpha Miner - AIæŒ–çŸ¿å·¥åŠ</h1>
            <p>æ™ºèƒ½Alphaå‘ç°ã€ä¸€é”®å›æµ‹ã€AIä¼˜åŒ–</p>
            <div class="login-info" id="login-email">è´¦å·ï¼šæœªæ£€æµ‹</div>
        </div>

        <!-- LLM Configuration -->
        <div class="workflow-section">
            <div class="section-title">ğŸ¤– AIæ¨¡å‹é…ç½®</div>
            <div class="llm-config">
                <div class="param-group">
                    <div class="param-item">
                        <label>Provider:</label>
                        <select id="llm-provider">
                            <option value="ollama">Ollama (æœ¬åœ°)</option>
                            <option value="deepseek">Deepseek</option>
                            <option value="openai">OpenAI</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label>Model:</label>
                        <input type="text" id="llm-model" value="qwen2.5:7b" placeholder="qwen2.5:7b">
                    </div>
                    <div class="param-item">
                        <label>API Base URL:</label>
                        <input type="text" id="llm-api-url" value="http://localhost:11434" placeholder="http://localhost:11434">
                    </div>
                    <div class="param-item">
                        <label>API Key (if needed):</label>
                        <input type="password" id="llm-api-key" placeholder="ç•™ç©ºä½¿ç”¨æœ¬åœ°">
                    </div>
                </div>
            </div>
        </div>

        <!-- Resources Display -->
        <div class="workflow-section">
            <div class="section-title">ğŸ“š å¯ç”¨èµ„æº</div>
            <button class="btn-generate" onclick="loadResources()" style="margin-bottom: 15px;">åŠ è½½èµ„æº</button>
            
            <div class="resources-grid" id="resources-container">
                <div class="resource-card">
                    <h3>Datasets</h3>
                    <div class="resource-list" id="datasets-list">
                        <p style="color: #999;">ç‚¹å‡»"åŠ è½½èµ„æº"è·å–</p>
                    </div>
                </div>
                <div class="resource-card">
                    <h3>Instruments</h3>
                    <div class="resource-list" id="instruments-list">
                        <p style="color: #999;">ç‚¹å‡»"åŠ è½½èµ„æº"è·å–</p>
                    </div>
                </div>
                <div class="resource-card">
                    <h3>æäº¤ç±»å‹</h3>
                    <div class="resource-list" id="submission-types">
                        <p style="color: #999;">ç‚¹å‡»"åŠ è½½èµ„æº"è·å–</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alpha Generation -->
        <div class="workflow-section">
            <div class="section-title">ğŸ¯ ç”ŸæˆAlpha</div>
            <div class="generation-panel">
                <div class="param-group">
                    <div class="param-item">
                        <label>Dataset:</label>
                        <input type="text" id="gen-dataset" placeholder="ä¾‹å¦‚: fundamental_data">
                    </div>
                    <div class="param-item">
                        <label>Instrument:</label>
                        <select id="gen-instrument">
                            <option value="EQUITY">EQUITY</option>
                            <option value="FUTURES">FUTURES</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label>Region:</label>
                        <select id="gen-region">
                            <option value="USA">USA</option>
                            <option value="CHN">CHN</option>
                            <option value="EUR">EUR</option>
                            <option value="JPN">JPN</option>
                            <option value="GLB">GLB</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label>Delay:</label>
                        <select id="gen-delay">
                            <option value="1">1</option>
                            <option value="0">0</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label>Strategy Type:</label>
                        <select id="gen-strategy">
                            <option value="momentum">Momentum</option>
                            <option value="reversal">Reversal</option>
                            <option value="value">Value</option>
                            <option value="quality">Quality</option>
                            <option value="growth">Growth</option>
                        </select>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-generate" onclick="generateAlpha()" id="btn-generate">
                        ğŸ² AIç”ŸæˆAlpha
                    </button>
                </div>
            </div>

            <!-- Generated Expression Display -->
            <div id="generated-result" style="display: none;">
                <div class="result-display">
                    <h3>ç”Ÿæˆçš„Alphaè¡¨è¾¾å¼ï¼š</h3>
                    <div class="expression-box" id="generated-expression"></div>
                    
                    <div class="param-group" style="margin-top: 20px;">
                        <div class="param-item">
                            <label>Universe:</label>
                            <select id="backtest-universe">
                                <option value="TOP3000">TOP3000</option>
                                <option value="TOP2000">TOP2000</option>
                                <option value="TOP1000">TOP1000</option>
                                <option value="TOP500">TOP500</option>
                            </select>
                        </div>
                        <div class="param-item">
                            <label>Neutralization:</label>
                            <select id="backtest-neutralization">
                                <option value="SUBINDUSTRY">SUBINDUSTRY</option>
                                <option value="INDUSTRY">INDUSTRY</option>
                                <option value="SECTOR">SECTOR</option>
                                <option value="MARKET">MARKET</option>
                            </select>
                        </div>
                        <div class="param-item">
                            <label>Decay:</label>
                            <select id="backtest-decay">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-generate" onclick="backtestAlpha()" id="btn-backtest">
                            ğŸš€ ä¸€é”®å›æµ‹
                        </button>
                        <button class="btn-generate" onclick="copyToClipboard()" style="background: #28a745;">
                            ğŸ“‹ å¤åˆ¶è¡¨è¾¾å¼
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backtest Results -->
        <div class="workflow-section" id="backtest-section" style="display: none;">
            <div class="section-title">ğŸ“Š å›æµ‹ç»“æœ</div>
            <div class="result-display">
                <div>
                    Alpha ID: <strong id="result-alpha-id"></strong>
                    <span class="status-badge status-running" id="result-status">è¿è¡Œä¸­...</span>
                </div>
                
                <div id="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p style="text-align: center;">æ­£åœ¨è·å–å›æµ‹ç»“æœ...</p>
                </div>

                <div id="performance-metrics" style="display: none;">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Fitness</div>
                            <div class="metric-value" id="metric-fitness">--</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sharpe</div>
                            <div class="metric-value" id="metric-sharpe">--</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Turnover</div>
                            <div class="metric-value" id="metric-turnover">--</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Returns</div>
                            <div class="metric-value" id="metric-returns">--</div>
                        </div>
                    </div>

                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn-generate" onclick="optimizeAlpha()" id="btn-optimize">
                            ğŸ”§ AIä¼˜åŒ–Alpha
                        </button>
                        <button class="btn-generate" onclick="viewOnPlatform()" style="background: #17a2b8;">
                            ğŸŒ åœ¨å¹³å°æŸ¥çœ‹
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimized Alpha -->
        <div class="workflow-section" id="optimized-section" style="display: none;">
            <div class="section-title">âœ¨ ä¼˜åŒ–åçš„Alpha</div>
            <div class="result-display">
                <h3>ä¼˜åŒ–å»ºè®®ï¼š</h3>
                <div class="expression-box" id="optimized-expression"></div>
                <div class="action-buttons">
                    <button class="btn-generate" onclick="useOptimizedExpression()">
                        âœ… ä½¿ç”¨ä¼˜åŒ–åè¡¨è¾¾å¼
                    </button>
                    <button class="btn-generate" onclick="backtestOptimized()" style="background: #ff6b6b;">
                        ğŸ”„ å›æµ‹ä¼˜åŒ–ç‰ˆæœ¬
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global state
        let currentAlphaId = null;
        let currentExpression = null;
        let currentParams = {};
        let checkInterval = null;

        function setResourceMessage(listId, message, isError) {
            const color = isError ? '#b00020' : '#999';
            const list = document.getElementById(listId);
            list.innerHTML = `<p style="color: ${color};">${message}</p>`;
        }

        function setResourceItems(listId, items) {
            const list = document.getElementById(listId);
            list.innerHTML = items;
        }

        // Load available resources
        async function loadResources() {
            try {
                const response = await fetch('/alpha-miner/api/get-resources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();
                
                if (result.success) {
                    const resources = result.resources;
                    const datasets = Array.isArray(resources.datasets) ? resources.datasets : [];
                    const instruments = Array.isArray(resources.instruments) ? resources.instruments : [];
                    const userProfile = resources.user_profile || {};
                    
                    // Display datasets
                    if (datasets.length) {
                        setResourceItems(
                            'datasets-list',
                            datasets.slice(0, 20).map(d =>
                                `<div class="resource-item" onclick="selectDataset('${d.id}')">${d.id} - ${d.name}</div>`
                            ).join('')
                        );
                    } else {
                        setResourceMessage('datasets-list', 'æœªè·å–åˆ°æ•°æ®é›†', true);
                    }
                    
                    // Display instruments
                    if (instruments.length) {
                        setResourceItems(
                            'instruments-list',
                            instruments.map(i => `<div class="resource-item">${i}</div>`).join('')
                        );
                    } else {
                        setResourceMessage('instruments-list', 'æœªè·å–åˆ°åˆçº¦ç±»å‹', true);
                    }
                    
                    // Display submission types
                    const types = [];
                    if (userProfile.can_submit_regular) types.push('Regular Alpha âœ“');
                    if (userProfile.can_submit_power_pool) types.push('Power Pool Alpha âœ“');
                    if (types.length) {
                        setResourceItems(
                            'submission-types',
                            types.map(t => `<div class="resource-item">${t}</div>`).join('')
                        );
                    } else {
                        setResourceMessage('submission-types', 'æœªè·å–åˆ°æäº¤ç±»å‹', true);
                    }
                    
                    console.log('âœ… èµ„æºåŠ è½½æˆåŠŸï¼');
                    document.getElementById('resources-container').style.border = '2px solid #28a745';
                    setTimeout(() => {
                        document.getElementById('resources-container').style.border = '';
                    }, 2000);
                } else {
                    console.error('åŠ è½½èµ„æºå¤±è´¥:', result.error);
                    setResourceMessage('datasets-list', 'åŠ è½½èµ„æºå¤±è´¥: ' + result.error, true);
                    setResourceMessage('instruments-list', 'åŠ è½½èµ„æºå¤±è´¥: ' + result.error, true);
                    setResourceMessage('submission-types', 'åŠ è½½èµ„æºå¤±è´¥: ' + result.error, true);
                }
            } catch (error) {
                console.error('Error loading resources:', error);
                setResourceMessage('datasets-list', 'åŠ è½½èµ„æºå‡ºé”™: ' + error.message, true);
                setResourceMessage('instruments-list', 'åŠ è½½èµ„æºå‡ºé”™: ' + error.message, true);
                setResourceMessage('submission-types', 'åŠ è½½èµ„æºå‡ºé”™: ' + error.message, true);
            }
        }

        function selectDataset(datasetId) {
            document.getElementById('gen-dataset').value = datasetId;
        }

        // Generate alpha using AI
        async function generateAlpha() {

            const dataset = document.getElementById('gen-dataset').value;
            if (!dataset) {
                document.getElementById('gen-dataset').style.border = '2px solid #dc3545';
                document.getElementById('gen-dataset').focus();
                setTimeout(() => {
                    document.getElementById('gen-dataset').style.border = '';
                }, 2000);
                return;
            }

            const btn = document.getElementById('btn-generate');
            btn.disabled = true;
            btn.textContent = 'â³ AIç”Ÿæˆä¸­...';

            try {
                const response = await fetch('/alpha-miner/api/generate-alpha', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dataset: dataset,
                        instrument: document.getElementById('gen-instrument').value,
                        region: document.getElementById('gen-region').value,
                        delay: parseInt(document.getElementById('gen-delay').value),
                        strategy_type: document.getElementById('gen-strategy').value,
                        provider: document.getElementById('llm-provider').value,
                        model: document.getElementById('llm-model').value,
                        api_base_url: document.getElementById('llm-api-url').value,
                        api_key: document.getElementById('llm-api-key').value
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentExpression = result.expression;
                    currentParams = result.parameters;
                    
                    document.getElementById('generated-expression').textContent = result.expression;
                    document.getElementById('generated-result').style.display = 'block';
                    
                    // Scroll to result
                    document.getElementById('generated-result').scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.error('ç”Ÿæˆå¤±è´¥:', result.error);
                    const statusDiv = document.createElement('div');
                    statusDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;';
                    statusDiv.textContent = 'AIç”Ÿæˆå¤±è´¥: ' + result.error;
                    document.querySelector('.generation-panel').appendChild(statusDiv);
                    setTimeout(() => statusDiv.remove(), 5000);
                }
            } catch (error) {
                console.error('Error generating alpha:', error);
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;';
                statusDiv.textContent = 'ç”Ÿæˆå‡ºé”™: ' + error.message;
                document.querySelector('.generation-panel').appendChild(statusDiv);
                setTimeout(() => statusDiv.remove(), 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ² AIç”ŸæˆAlpha';
            }
        }

        // Backtest alpha
        async function backtestAlpha() {
            if (!currentExpression) {
                document.getElementById('btn-generate').style.animation = 'shake 0.5s';
                setTimeout(() => {
                    document.getElementById('btn-generate').style.animation = '';
                }, 500);
                return;
            }

            const btn = document.getElementById('btn-backtest');
            btn.disabled = true;
            btn.textContent = 'â³ æäº¤ä¸­...';

            try {
                const response = await fetch('/alpha-miner/api/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        expression: currentExpression,
                        instrument: currentParams.instrument,
                        region: currentParams.region,
                        delay: currentParams.delay,
                        universe: document.getElementById('backtest-universe').value,
                        neutralization: document.getElementById('backtest-neutralization').value,
                        decay: parseInt(document.getElementById('backtest-decay').value)
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentAlphaId = result.alpha_id;
                    
                    document.getElementById('result-alpha-id').textContent = result.alpha_id;
                    document.getElementById('backtest-section').style.display = 'block';
                    document.getElementById('loading-indicator').style.display = 'block';
                    
                    // Start checking simulation status
                    startStatusCheck();
                    
                    // Scroll to result
                    document.getElementById('backtest-section').scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.error('å›æµ‹å¤±è´¥:', result.error);
                    const statusDiv = document.createElement('div');
                    statusDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;';
                    statusDiv.textContent = 'å›æµ‹å¤±è´¥: ' + result.error;
                    document.getElementById('generated-result').appendChild(statusDiv);
                    setTimeout(() => statusDiv.remove(), 5000);
                }
            } catch (error) {
                console.error('Error backtesting:', error);
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;';
                statusDiv.textContent = 'å›æµ‹å‡ºé”™: ' + error.message;
                document.getElementById('generated-result').appendChild(statusDiv);
                setTimeout(() => statusDiv.remove(), 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ä¸€é”®å›æµ‹';
            }
        }

        // Check simulation status
        function startStatusCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
            }

            checkInterval = setInterval(async () => {
                try {
                    const response = await fetch('/alpha-miner/api/check-simulation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            alpha_id: currentAlphaId
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        const status = result.status;
                        const statusBadge = document.getElementById('result-status');
                        
                        if (status === 'COMPLETE') {
                            clearInterval(checkInterval);
                            statusBadge.textContent = 'å®Œæˆ';
                            statusBadge.className = 'status-badge status-complete';
                            
                            // Display metrics
                            document.getElementById('loading-indicator').style.display = 'none';
                            document.getElementById('performance-metrics').style.display = 'block';
                            
                            const perf = result.performance;
                            document.getElementById('metric-fitness').textContent = perf.fitness?.toFixed(3) || '--';
                            document.getElementById('metric-sharpe').textContent = perf.sharpe?.toFixed(3) || '--';
                            document.getElementById('metric-turnover').textContent = perf.turnover?.toFixed(3) || '--';
                            document.getElementById('metric-returns').textContent = perf.returns?.toFixed(6) || '--';
                        } else if (status === 'ERROR') {
                            clearInterval(checkInterval);
                            statusBadge.textContent = 'é”™è¯¯';
                            statusBadge.className = 'status-badge status-error';
                            document.getElementById('loading-indicator').style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 5000); // Check every 5 seconds
        }

        // Optimize alpha
        async function optimizeAlpha() {
            const btn = document.getElementById('btn-optimize');
            btn.disabled = true;
            btn.textContent = 'â³ AIä¼˜åŒ–ä¸­...';

            try {
                const performance = {
                    fitness: parseFloat(document.getElementById('metric-fitness').textContent),
                    sharpe: parseFloat(document.getElementById('metric-sharpe').textContent),
                    turnover: parseFloat(document.getElementById('metric-turnover').textContent),
                    returns: parseFloat(document.getElementById('metric-returns').textContent)
                };

                const response = await fetch('/alpha-miner/api/optimize-alpha', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        expression: currentExpression,
                        performance: performance,
                        provider: document.getElementById('llm-provider').value,
                        model: document.getElementById('llm-model').value,
                        api_base_url: document.getElementById('llm-api-url').value,
                        api_key: document.getElementById('llm-api-key').value
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('optimized-expression').textContent = result.optimized_expression;
                    document.getElementById('optimized-section').style.display = 'block';
                    document.getElementById('optimized-section').scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.error('ä¼˜åŒ–å¤±è´¥:', result.error);
                    const statusDiv = document.createElement('div');
                    statusDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;';
                    statusDiv.textContent = 'AIä¼˜åŒ–å¤±è´¥: ' + result.error;
                    document.getElementById('backtest-section').appendChild(statusDiv);
                    setTimeout(() => statusDiv.remove(), 5000);
                }
            } catch (error) {
                console.error('Error optimizing:', error);
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;';
                statusDiv.textContent = 'ä¼˜åŒ–å‡ºé”™: ' + error.message;
                document.getElementById('backtest-section').appendChild(statusDiv);
                setTimeout(() => statusDiv.remove(), 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”§ AIä¼˜åŒ–Alpha';
            }
        }

        function useOptimizedExpression() {
            const optimized = document.getElementById('optimized-expression').textContent;
            currentExpression = optimized;
            document.getElementById('generated-expression').textContent = optimized;
            document.getElementById('generated-result').scrollIntoView({ behavior: 'smooth' });
            // Visual feedback
            document.getElementById('generated-expression').style.background = '#d4edda';
            setTimeout(() => {
                document.getElementById('generated-expression').style.background = '#f8f9fa';
            }, 2000);
        }

        function backtestOptimized() {
            useOptimizedExpression();
            setTimeout(() => {
                backtestAlpha();
            }, 500);
        }

        function copyToClipboard() {
            const expression = document.getElementById('generated-expression').textContent;
            navigator.clipboard.writeText(expression).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }

        function viewOnPlatform() {
            if (currentAlphaId) {
                window.open(`https://platform.worldquantbrain.com/alpha/${currentAlphaId}`, '_blank');
            }
        }

        async function loadLoginEmail() {
            try {
                const response = await fetch('/api/get-saved-credentials');
                const data = await response.json();
                if (data.success && data.email) {
                    document.getElementById('login-email').textContent = `è´¦å·ï¼š${data.email}`;
                } else {
                    document.getElementById('login-email').textContent = 'è´¦å·ï¼šæœªæ£€æµ‹';
                }
            } catch (error) {
                console.error('Error loading email:', error);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadLoginEmail();
        });

    </script>
</body>
</html>
